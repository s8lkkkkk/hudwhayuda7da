<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Memorial Tree of Life</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<h1>Memorial Tree of Life</h1>

<form id="addForm">
  <input type="text" id="name" placeholder="Name (optional)"><br>
  <textarea id="desc" placeholder="Message (optional)"></textarea><br>
  <input type="file" id="photo" accept="image/*"><br>
  <button type="submit">Add Leaf</button>
</form>

<div class="tree" id="tree"></div>

<div class="modal" id="modal">
  <div class="modal-content" id="modalContent"></div>
</div>

<div id="adminPopup">
  <div id="adminNodes"></div>
</div>

<script>
const tree = document.getElementById("tree");
const form = document.getElementById("addForm");
const modal = document.getElementById("modal");
const modalContent = document.getElementById("modalContent");
const adminPopup = document.getElementById("adminPopup");
const adminNodes = document.getElementById("adminNodes");

let isAdmin = false;
const key = prompt("Enter admin key (optional):");
if(key==="Jagger.0011"){ isAdmin=true; adminPopup.style.display="block"; }

async function readFileAsDataURL(file){
  return new Promise(resolve=>{
    if(!file) return resolve('');
    const reader=new FileReader();
    reader.onload=()=>resolve(reader.result);
    reader.readAsDataURL(file);
  });
}

async function loadLeaves(){
  const res = await fetch('/api/nodes.json');
  const nodes = await res.json();
  tree.innerHTML = '';
  adminNodes.innerHTML = '';

  nodes.forEach((n,i)=>{
    const leaf = document.createElement("div");
    leaf.className = "leaf";
    leaf.style.left = (Math.random()*(tree.clientWidth-40))+"px";
    leaf.style.top = (Math.random()*(tree.clientHeight-60))+"px";
    if(n.photo) leaf.innerHTML = `<img src="${n.photo}">`;
    leaf.addEventListener("click", ()=> {
      modalContent.innerHTML = `<strong>${n.name}</strong><br>${n.desc}`;
      modal.style.display = "flex";
    });
    tree.appendChild(leaf);

    if(isAdmin){
      const btn=document.createElement("button");
      btn.textContent = `Delete ${n.name}`;
      btn.addEventListener("click", async ()=>{
        await fetch('/api/delete',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({id:n.id,key:'Jagger.0011'})
        });
        loadLeaves();
      });
      adminNodes.appendChild(btn);
    }
  });
}

form.addEventListener("submit", async e=>{
  e.preventDefault();
  const name = document.getElementById("name").value || "Anonymous";
  const desc = document.getElementById("desc").value || "";
  const file = document.getElementById("photo").files[0];
  const photo = await readFileAsDataURL(file);

  await fetch("/api/upload",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({name,desc,photo})
  });
  form.reset();
  loadLeaves();
});

modal.addEventListener("click", ()=> modal.style.display="none");

loadLeaves();
</script>

</body>
</html>
